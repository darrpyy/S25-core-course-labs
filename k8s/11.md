# Secrets and Vault

## Kubectl Secrets

Create secret

```bash
kubectl create secret generic my-secret --from-literal=PASS=hehe_password
secret/my-secret created
```

Get the secret

```bash
kubectl get secrets
NAME                                    TYPE                 DATA   AGE
my-secret                               Opaque               1      79s
sh.helm.release.v1.app-python-helm.v1   helm.sh/release.v1   1      20m
```

Describe the secret

```bash
kubectl describe secret my-secret
Name:         my-secret
Namespace:    default
Labels:       <none>
Annotations:  <none>

Type:  Opaque

Data
====
PASS:  13 bytes
```

Get the value

```bash
kubectl get secret my-secret -o jsonpath="{.data.PASS}" | base64 --decode
hehe_password
```

## Helm Secrets

Install app with Helm Secrets

```bash
helm secrets install app-python-helm ./app-python-helm/ -f ./secrets.yaml
NAME: app-python-helm
LAST DEPLOYED: Tue Apr 29 19:41:09 2025
NAMESPACE: default
STATUS: deployed
REVISION: 1
NOTES:
1. Get the application URL by running these commands:
  export POD_NAME=$(kubectl get pods --namespace default -l "app.kubernetes.io/name=app-python-helm,app.kubernetes.io/instance=app-python-helm" -o jsonpath="{.items[0].metadata.name}")
  export CONTAINER_PORT=$(kubectl get pod --namespace default $POD_NAME -o jsonpath="{.spec.containers[0].ports[0].containerPort}")
  echo "Visit http://127.0.0.1:8080 to use your application"
  kubectl --namespace default port-forward $POD_NAME 8080:$CONTAINER_PORT
removed './secrets.yaml.dec'
```

```bash
kubectl get po
NAME                               READY   STATUS    RESTARTS   AGE
app-python-helm-779b89b556-2q72s   1/1     Running   0          62s
```

```bash
kubectl exec app-python-helm-779b89b556-2q72s  -- printenv | grep PASS
PASS=hehehehe_password
```

## Vault

```bash
kubectl exec -it vault-0 -- /bin/sh
/ $ 
```

```bash
vault secrets enable -path=internal kv-v2
Success! Enabled the kv-v2 secrets engine at: internal/
```

```bash
vault kv put internal/database/config username="db-readonly-username" password="db-secret-password"
======== Secret Path ========
internal/data/database/config

======= Metadata =======
Key                Value
---                -----
created_time       2025-04-29T17:00:11.108451326Z
custom_metadata    <nil>
deletion_time      n/a
destroyed          false
version            1
```

```bash
vault kv get internal/database/config
======== Secret Path ========
internal/data/database/config

======= Metadata =======
Key                Value
---                -----
created_time       2025-04-29T17:00:11.108451326Z
custom_metadata    <nil>
deletion_time      n/a
destroyed          false
version            1

====== Data ======
Key         Value
---         -----
password    db-secret-password
username    db-readonly-username
```

```bash
vault auth enable kubernetes
Success! Enabled kubernetes auth method at: kubernetes/
```

```bash
vault write auth/kubernetes/config kubernetes_host="https://$KUBERNETES_PORT_443_TCP_ADDR:443"
Success! Data written to: auth/kubernetes/config
```

```bash
vault policy write app-python - <<EOF
> path "internal/data/database/config" {
>     capabilities = ["read"]
> }
> EOF
Success! Uploaded policy: app-python
```

```bash
vault write auth/kubernetes/role/app-python \
    bound_service_account_names=app-python \
    bound_service_account_namespaces=default \
    policies=app-python \
    ttl=24h
Success! Data written to: auth/kubernetes/role/app-python
```

```bash
/ $ exit
command terminated with exit code 130
```

```bash
kubectl annotate sa app-python \
    meta.helm.sh/release-name=app-python-helm \
    meta.helm.sh/release-namespace=default --overwrite
serviceaccount/app-python annotated
```

```bash
helm secrets install app-python-helm ./app-python-helm/ -f secrets.yaml
NAME: app-python-helm
LAST DEPLOYED: Tue Apr 29 20:07:06 2025
NAMESPACE: default
STATUS: deployed
REVISION: 1
NOTES:
1. Get the application URL by running these commands:
  export POD_NAME=$(kubectl get pods --namespace default -l "app.kubernetes.io/name=app-python-helm,app.kubernetes.io/instance=app-python-helm" -o jsonpath="{.items[0].metadata.name}")
  export CONTAINER_PORT=$(kubectl get pod --namespace default $POD_NAME -o jsonpath="{.spec.containers[0].ports[0].containerPort}")
  echo "Visit http://127.0.0.1:8080 to use your application"
  kubectl --namespace default port-forward $POD_NAME 8080:$CONTAINER_PORT
removed 'secrets.yaml.dec'
```

```bash
kubectl get po
NAME                                    READY   STATUS    RESTARTS   AGE
app-python-helm-779b89b556-mghtj        1/1     Running   0          27s
vault-0                                 1/1     Running   0          19m
vault-agent-injector-75f9dfc9c8-994jj   1/1     Running   0          19m
```

```bash
kubectl patch deployment app-python-helm --patch-file=./app-python-helm/patch-inject-secrets.yaml
deployment.apps/app-python-helm patched
```

```bash
kubectl get po
NAME                                    READY   STATUS        RESTARTS   AGE
app-python-helm-6746d67865-h25j8        2/2     Running       0          18s
app-python-helm-779b89b556-mghtj        1/1     Terminating   0          57s
vault-0                                 1/1     Running       0          19m
vault-agent-injector-75f9dfc9c8-994jj   1/1     Running       0          19m
```

```bash
kubectl get po
NAME                                    READY   STATUS    RESTARTS   AGE
app-python-helm-6746d67865-h25j8        2/2     Running   0          35s
vault-0                                 1/1     Running   0          20m
vault-agent-injector-75f9dfc9c8-994jj   1/1     Running   0          20m
```

```bash
kubectl exec -it app-python-helm-6746d67865-h25j8 --container app-python-helm -- cat /vault/secrets/database-config.txt
data: map[password:db-secret-password username:db-readonly-username]
metadata: map[created_time:2025-04-29T17:00:11.108451326Z custom_metadata:<nil> deletion_time: destroyed:false version:1]
```

```bash
kubectl exec -it app-python-helm-6746d67865-h25j8 --container app-python-helm -- df -h
Filesystem      Size  Used Avail Use% Mounted on
overlay         140G   35G   99G  26% /
tmpfs            64M     0   64M   0% /dev
shm              64M     0   64M   0% /dev/shm
tmpfs            16G  4.0K   16G   1% /vault/secrets
/dev/nvme0n1p5  140G   35G   99G  26% /etc/hosts
tmpfs            16G   12K   16G   1% /run/secrets/kubernetes.io/serviceaccount
tmpfs           7.7G     0  7.7G   0% /proc/asound
tmpfs           7.7G     0  7.7G   0% /proc/acpi
tmpfs           7.7G     0  7.7G   0% /proc/scsi
tmpfs           7.7G     0  7.7G   0% /sys/firmware
tmpfs           7.7G     0  7.7G   0% /sys/devices/virtual/powercap
```

```bash

```